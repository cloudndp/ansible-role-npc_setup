---

# Setup npc instances
- hosts: localhost
  gather_facts: 'no'
  vars:
    npc_setup:
      absent: omit
    npc_config:
      ssh_key: 
        name: ansible-tests
      default_instance_image: Debian 8.6
      default_instance_type:
        cpu: 2
        memory: 4G
      ssh_jump_host: debian-test-gw
    npc_instances: 
      - name: 'debian-test-gw'
        wan_ip: any
        wan_capacity: 100m
        ssh_host_by: wan_ip
        ssh_jump_host: false
        groups:
          - gw
          - jump

      - name: 'debian-test-w-{a..b}'
        groups:
          - worker
        vars:
          host_var1: value
  roles: 
    - ../ansible-role-npc_setup
  tasks:
    - debug: msg={{groups["all"]}}

- hosts: gw
  tasks:
    - sysctl:
        name: net.ipv4.ip_forward
        value: 1
        sysctl_set: yes
        state: present
        reload: yes
    - iptables:
        table: nat
        chain: POSTROUTING
        source: 10.173.0.0/16
        jump: SNAT
        to_source: '{{npc_instance.wan_ip}}'
    - with_items: '{{groups["worker"]}}'
      shell: route del default; route add default gw {{npc_instance.lan_ip}}
      delegate_to: '{{item}}'
    
